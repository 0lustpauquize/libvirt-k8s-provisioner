---
- name: This play installs needed tools to provision infrastructure VMs
  hosts: vm_host
  vars_files:
    - vars/k8s_cluster.yml    
  tasks:

    - name: Ensure pool path exists
      file:
        path: "{{ libvirt.storage.pool_path }}/{{ k8s.cluster_name }}"
        state: directory
      become: true

    - name: Define libvirt network
      virt_net:
        command: define
        name: "{{ k8s.cluster_name }}"
        xml: '{{ lookup("template", "templates/libvirt_network.xml.j2") }}'

    - name: Make libvirt network autostart
      virt_net:
        name: "{{ k8s.cluster_name }}"
        autostart: true

    - name: Start libvirt network
      virt_net:
        command: start
        name: "{{ k8s.cluster_name }}"
        state: active

    - name: Define libvirt pool
      virt_pool:
        command: define
        name: "{{ k8s.cluster_name }}"
        xml: '{{ lookup("template", "templates/libvirt_pool.xml.j2") }}'

    - name: Make libvirt pool autostart
      virt_pool:
        name: "{{ k8s.cluster_name }}"
        autostart: true

    - name: Start libvirt pool
      virt_pool:
        command: start
        name: "{{ k8s.cluster_name }}"
        state: active

    - name: Configure NetworkManager for local DNS
      copy:
        src: files/localdns.conf
        dest: /etc/NetworkManager/conf.d/localdns.conf
      become: true

    - name: Configure NetworkManager for libvirt network
      template:
        src: templates/libvirt_dnsmasq.j2
        dest: /etc/NetworkManager/dnsmasq.d/libvirt_dnsmasq.conf
      become: true

    - name: Restart NetworkManager
      service:
        name: NetworkManager
        state: restarted
      become: true

    - name: Wait for local DNS resolver to be up
      wait_for:
        port: 53
        delay: 10
