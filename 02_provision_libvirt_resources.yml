- name: This play provisions libvirt resources with terraform
  hosts: vm_host
  become: true
  vars_files:
    - vars/k8s_cluster.yml
    
  tasks:
    - name: Use TF project to ensure pool and network are defined
      terraform:
        project_path: "files/terraform/libvirt-resources"
        variables:
          domain: "{{ k8s.network.domain }}"
          network_cidr: ' ["{{ k8s.network.network_cidr }}"]'
          cluster_name: "{{ k8s.cluster_name }}"
        force_init: true
        state: present
      register: output_masters

#TODO add qemu permissions for apparmour
#
    - name: Take care of systemd-resolved on F33 and Ubuntu hosts
      block:
      - name: Remove the resolve.conf file
        file:
          path: /etc/systemd/resolved.conf.d/
          state: directory

      - name: Enable localdns if systemd-resolved is present
        template:
          src: systemd-resolved.j2
          dest: /etc/systemd/resolved.conf.d/local-kube.conf

      - name: Restart systemd-resolve
        service:
          name: systemd-resolved
          state: restarted
          enabled: true
      when: (ansible_distribution == 'Fedora' and ansible_distribution_major_version == '33') or (ansible_distribution == 'Ubuntu' and ansible_distribution_major_version >= '18')

    - name: Ensure NM configuration directory exists
      file:
        path: /etc/NetworkManager/conf.d
        state: directory

    - name: Ensure NM dnsmasq directory exists
      file:
        path: /etc/NetworkManager/dnsmasq.d
        state: directory        

    - name: Configure NetworkManager for local DNS
      copy:
        src: files/localdns.conf
        dest: /etc/NetworkManager/conf.d/localdns.conf
      notify: 
        - Restart NetworkManager

    - name: Configure NetworkManager for libvirt network
      template:
        src: templates/libvirt_dnsmasq.j2
        dest: /etc/NetworkManager/dnsmasq.d/libvirt_dnsmasq.conf

#TODO restart resolved
  handlers:
    - name: Restart NetworkManager
      service:
        name: NetworkManager
        state: restarted

    - name: Wait for local DNS resolver to be up
      wait_for:
        port: 53
        delay: 10
      when: not (ansible_distribution == 'Fedora' and ansible_distribution_major_version == '33') or (ansible_distribution == 'Ubuntu' and ansible_distribution_major_version >= '18')
